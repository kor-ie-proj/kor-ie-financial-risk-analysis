# 모델 설계 및 운영

## 데이터 소스

- **ECOS 거시 지표** (`ecos_data` 테이블): `construction_bsi_actual`(건설업 BSI 실적), `base_rate`(기준금리), `housing_sale_price`(주택매매가격), `m2_growth`(M2 성장률)에 대한 월별 시계열 데이터를 제공합니다.
- **DART 재무제표** (`dart_data` 테이블): 리스크 플래그 및 백분위 점수 산정에 사용되는 분기별 기업 재무 지표와 원본 값을 제공합니다.
- 훈련과 추론은 동일한 ECOS 피처 공간을 공유하며, 추론 단계에서는 DART 기반 휴리스틱(heuristics)으로 결과를 확장합니다.

## 훈련 파이프라인 (`training/app/training_logic.py`)

### 전처리 및 피처 엔지니어링

- ECOS `date` 문자열(YYYYMM 형식)을 타임스탬프로 파싱하고, 날짜순으로 정렬 후 인덱스로 설정합니다.
- 누락된 값은 양방향 선형 보간법으로 채웁니다.
- 사용 가능한 모든 타겟 변수에 대해 1차 차분(first differences)을 계산한 후, 각 타겟별로 피처 블록을 생성합니다:
  - 3개월 및 6개월 이동 평균, 차분된 신호의 변화율, 그리고 1, 3, 6개월 시차(lag)를 생성합니다.
  - 저주파수 맥락을 유지하기 위해 원본 레벨 값의 시차(1, 3, 6개월)도 추가합니다.
- 결측치가 남아있는 행은 제거하고, 피처 간 상관계수 절대값이 0.95를 초과하는 쌍을 제거하여 다중공선성이 높은 피처를 정리합니다.
- 살아남은 피처들을 모든 차분된 타겟과의 평균 절대 상관계수 기준으로 순위를 매기고, 상위 `max(20, 전체 피처의 50%)`개를 최종 입력 벡터로 사용합니다.

### 시퀀스 준비 및 스케일링

- 입력(X)과 다음 스텝의 타겟(y)에 대해 `seq_length`(하이퍼파라미터 후보) 길이의 슬라이딩 윈도우를 생성합니다.
- 시퀀스를 시간 순서에 따라 훈련(약 80%), 검증(약 10%), 테스트(약 10%) 세트로 분할합니다.
- 훈련 세트의 윈도우 데이터를 평탄화(flatten)하여 `StandardScaler`를 X와 y에 각각 학습(fit)시킨 후, 모든 데이터 세트에 변환(transform)을 적용합니다.
- 데이터를 `TensorDataset`/`DataLoader`로 변환하고 GPU에 배치하며, 검증 및 테스트 시에는 시간 순서를 유지하기 위해 셔플링하지 않습니다.

### 베이스라인 및 평가지표

- 차분된 타겟에 대해 Naive, 계절성 Naive(12개월 주기), 과거 평균 베이스라인을 생성합니다.
- 각 베이스라인을 RMSE, MAE, R² 지표로 평가하여 LSTM 모델의 성능을 비교할 벤치마크를 설정합니다.
- 최종 평가 시에는 역정규화된 차분 시계열에 대해 방향성 정확도(directional accuracy)도 계산합니다.

### 모델 및 최적화

- **모델**: `MultivariateLSTM(input_dim=len(final_features), hidden_size, num_layers, output_dim=len(targets), dropout)`
- **하이퍼파라미터 탐색**: Optuna를 사용하여 50회 시도 또는 10분 시간 초과 조건으로 은닉층 크기, 레이어 수, 드롭아웃 비율, 학습률, 배치 크기, 시퀀스 길이, 옵티마이저(Adam/AdamW), 가중치 감쇠(weight decay), 손실 함수(MSE/MAE/Huber)를 탐색합니다.
- **각 탐색(Trial)**: 최대 30 에포크 동안 그래디언트 클리핑(norm 1.0)을 적용하여 훈련하며, 조기 종료(patience 10) 및 검증 손실 기반 프루닝(pruning)을 사용합니다.
- **최종 훈련**: 최적의 파라미터를 사용하여 최대 200 에포크 동안 훈련합니다. 이때 ReduceLROnPlateau(factor 0.5, patience 5) 스케줄러와 조기 종료(patience 20)를 사용하며, 에포크별 손실을 MLflow에 기록합니다.

### 아티팩트 및 로깅

- 최적 탐색의 평가지표, 베이스라인 점수, 최종 손실, 테스트 평가지표를 MLflow (`LSTM_Financial_Forecast` 프로젝트)에 기록합니다.
- 후속 추론 파이프라인에서 사용할 수 있도록 피클링된 아티팩트(`model_state_dict`, 스케일러, 피처 목록, 하이퍼파라미터, 손실 기록, 평가지표)와 PyTorch 모델(명시적인 `requirements.txt` 포함)을 저장합니다.

## 추론 파이프라인 (`inference/app/inference_logic.py`)

### 월별 타겟 예측

- ECOS 과거 데이터를 로드하고, 훈련과 동일한 전처리(날짜 파싱, 보간, 차분 기반 피처 및 시차 생성)를 적용합니다.
- 변환 후 데이터에 저장된 `final_feature`가 모두 존재하는지 검증하며, 하나라도 누락되면 프로세스를 중단합니다.
- 가장 최근 `seq_length` 길이의 데이터를 슬라이싱하고, 저장된 `scaler_X`로 스케일링한 후, 훈련된 LSTM 모델을 통해 다음 스텝의 차분된 타겟을 예측합니다.
- 예측된 출력값을 역스케일링한 후, 차분 예측값을 반복적으로 누적하여 원본 스케일의 `months_to_predict` 개월치 예측값을 생성합니다.

### 휴리스틱 리스크 통합

- 선택된 `corp_name`(기업명)과 전체 동종업계(peer) 집단의 DART 데이터를 가져와 백분위 점수 산정을 지원하고, 최신 보고 분기를 식별합니다.
- DART 시계열 데이터로부터 가중치 기반 규칙 점검을 통해 원시 플래그 점수(자본 잠식, 매출 연속성, 레버리지, 수익성 악화 등)를 계산합니다.
- 최신 분기에 대해 레버리지, 자본, ROA/ROE, 성장성 지표 등을 동종업계와 비교하여 백분위 점수(0–10점)를 산출합니다. 이때 규모 기반 부채 페널티와 상하한 처리(clipping)를 적용합니다.
- 참조 분기에 대한 실제 ECOS 분기 평균을 계산하고, 다음 분기의 ECOS 벡터를 다음 두 가지 방법 중 하나로 구성합니다:
  - **예측 모드**: LSTM 월별 예측치를 다음 분기로 매핑하고, 실제값이 있는 경우 해당 값으로 채웁니다.
  - **수동 모드**: 분석가가 제공한 조정값(`base_rate`는 절대값 델타, 나머지는 비율 변화)을 적용합니다.
- 예측된 분기를 과거 ECOS 분기 데이터와 백분위로 비교하여 점수화하며, 각 지표의 리스크 방향성을 존중합니다.
- 원시 플래그 점수를 0–10점 척도로 스케일링(최대 20점에서 capping)하고, 13개의 구성 요소를 사전에 정의된 가중치와 결합합니다. 최종 휴리스틱 점수는 `(Σ 가중치 × 점수) × 10` 공식으로 계산되며, 0–100 사이로 제한됩니다.
- 이 종합 점수를 미리 설정된 임계값을 사용하여 `낮음(Low)`, `보통(Moderate)`, `높음(High)`, `위험(Critical)`과 같은 이산적인 리스크 레벨로 매핑합니다.

## 주요 가정 및 실패 시나리오

- ECOS 전처리 시 충분한 과거 데이터(최소 `seq_length` 행)와 모든 피처 컬럼이 존재해야 합니다. 그렇지 않으면 추론 시 명시적인 오류가 발생합니다.
- 동종업계 벤치마킹은 대상 기업의 분기별 DART 데이터가 존재한다고 가정합니다. 데이터가 누락된 분기는 중간 점수로 처리되지만, 결과의 해석 가능성이 저하됩니다.
- 차분된 타겟을 예측하는 설계는 누적 합계를 통해 원본 레벨 값을 예측함을 의미합니다. 따라서 예측 기간이 길어지면 편향(bias)이 누적될 수 있으므로, 후속 사용자는 드리프트(drift)를 지속적으로 모니터링해야 합니다.
- 수동 조정 기능은 LSTM 모델을 우회하지만, 점수 산정의 일관성을 위해 동일한 가중치 및 백분위 산정 인프라를 사용합니다.
